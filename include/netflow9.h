/*
 * Copyright Â© 2019-2020 Exatel S.A.
 * Contact: github@exatel.pl
 * LICENSE: LGPL-3.0-or-later, See COPYING*.md files.
 *
 * This program is free software: you can redistribute it and/or modify it under
 * the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */

#ifndef NETFLOW9_H
#define NETFLOW9_H

#include <stddef.h>
#include <stdint.h>

#include <netinet/in.h>
#include <sys/socket.h>

#ifdef NF9_BUILD
#define NF9_API __attribute__((__visibility__("default")))
#else
#define NF9_API
#endif

#ifdef __cplusplus
extern "C" {
#endif

typedef uint32_t nf9_field;

#ifdef __cplusplus
#define NF9_DATA_FIELD(value) (static_cast<nf9_field>(value))
#define NF9_SCOPE_FIELD(value) (static_cast<nf9_field>(value | (1 << 31)))
#else
#define NF9_DATA_FIELD(value) ((nf9_field)value)
#define NF9_SCOPE_FIELD(value) ((nf9_field)(value | (1 << 31)))
#endif

enum nf9_state_flag {
    // NF9 reserved
    NF9_THREAD_SAFE = 1,
};

enum nf9_flowset_type {
    NF9_FLOWSET_TEMPLATE,
    NF9_FLOWSET_OPTIONS,
    NF9_FLOWSET_DATA,
};

enum nf9_stat {
    NF9_STAT_PROCESSED_PACKETS,
    NF9_STAT_MALFORMED_PACKETS,
    NF9_STAT_TOTAL_RECORDS,
    NF9_STAT_TOTAL_DATA_TEMPLATES,
    NF9_STAT_TOTAL_OPTION_TEMPLATES,
    NF9_STAT_MISSING_TEMPLATE_ERRORS,
    NF9_STAT_EXPIRED_OBJECTS,
    NF9_STAT_MEMORY_USAGE,
};

enum nf9_opt {
    NF9_OPT_MAX_MEM_USAGE,
    NF9_OPT_TEMPLATE_EXPIRE_TIME,
    NF9_OPT_OPTION_EXPIRE_TIME,
};

typedef union nf9_addr {
    sa_family_t family;
    struct sockaddr_in in;
    struct sockaddr_in6 in6;
} nf9_addr;

enum nf9_data_field {
    NF9_FIELD_F0 = NF9_DATA_FIELD(0),
    NF9_FIELD_IN_BYTES = NF9_DATA_FIELD(1),
    NF9_FIELD_IN_PKTS = NF9_DATA_FIELD(2),
    NF9_FIELD_FLOWS = NF9_DATA_FIELD(3),
    NF9_FIELD_PROTOCOL = NF9_DATA_FIELD(4),
    NF9_FIELD_TOS = NF9_DATA_FIELD(5),
    NF9_FIELD_TCP_FLAGS = NF9_DATA_FIELD(6),
    NF9_FIELD_L4_SRC_PORT = NF9_DATA_FIELD(7),
    NF9_FIELD_IPV4_SRC_ADDR = NF9_DATA_FIELD(8),
    NF9_FIELD_SRC_MASK = NF9_DATA_FIELD(9),
    NF9_FIELD_INPUT_SNMP = NF9_DATA_FIELD(10),
    NF9_FIELD_L4_DST_PORT = NF9_DATA_FIELD(11),
    NF9_FIELD_IPV4_DST_ADDR = NF9_DATA_FIELD(12),
    NF9_FIELD_DST_MASK = NF9_DATA_FIELD(13),
    NF9_FIELD_OUTPUT_SNMP = NF9_DATA_FIELD(14),
    NF9_FIELD_IPV4_NEXT_HOP = NF9_DATA_FIELD(15),
    NF9_FIELD_SRC_AS = NF9_DATA_FIELD(16),
    NF9_FIELD_DST_AS = NF9_DATA_FIELD(17),
    NF9_FIELD_BGP_IPV4_NEXT_HOP = NF9_DATA_FIELD(18),
    NF9_FIELD_MUL_DST_PKTS = NF9_DATA_FIELD(19),
    NF9_FIELD_MUL_DST_BYTES = NF9_DATA_FIELD(20),
    NF9_FIELD_LAST_SWITCHED = NF9_DATA_FIELD(21),
    NF9_FIELD_FIRST_SWITCHED = NF9_DATA_FIELD(22),
    NF9_FIELD_OUT_BYTES = NF9_DATA_FIELD(23),
    NF9_FIELD_OUT_PKTS = NF9_DATA_FIELD(24),
    NF9_FIELD_F25 = NF9_DATA_FIELD(25),
    NF9_FIELD_F26 = NF9_DATA_FIELD(26),
    NF9_FIELD_IPV6_SRC_ADDR = NF9_DATA_FIELD(27),
    NF9_FIELD_IPV6_DST_ADDR = NF9_DATA_FIELD(28),
    NF9_FIELD_IPV6_SRC_MASK = NF9_DATA_FIELD(29),
    NF9_FIELD_IPV6_DST_MASK = NF9_DATA_FIELD(30),
    NF9_FIELD_IPV6_FLOW_LABEL = NF9_DATA_FIELD(31),
    NF9_FIELD_ICMP_TYPE = NF9_DATA_FIELD(32),
    NF9_FIELD_MUL_IGMP_TYPE = NF9_DATA_FIELD(33),
    NF9_FIELD_SAMPLING_INTERVAL = NF9_DATA_FIELD(34),
    NF9_FIELD_SAMPLING_ALGORITHM = NF9_DATA_FIELD(35),
    NF9_FIELD_FLOW_ACTIVE_TIMEOUT = NF9_DATA_FIELD(36),
    NF9_FIELD_FLOW_INACTIVE_TIMEOUT = NF9_DATA_FIELD(37),
    NF9_FIELD_ENGINE_TYPE = NF9_DATA_FIELD(38),
    NF9_FIELD_ENGINE_ID = NF9_DATA_FIELD(39),
    NF9_FIELD_TOTAL_BYTES_EXP = NF9_DATA_FIELD(40),
    NF9_FIELD_TOTAL_PKTS_EXP = NF9_DATA_FIELD(41),
    NF9_FIELD_TOTAL_FLOWS_EXP = NF9_DATA_FIELD(42),
    NF9_FIELD_F43 = NF9_DATA_FIELD(43),
    NF9_FIELD_F44 = NF9_DATA_FIELD(44),
    NF9_FIELD_F45 = NF9_DATA_FIELD(45),
    NF9_FIELD_MPLS_TOP_LABEL_TYPE = NF9_DATA_FIELD(46),
    NF9_FIELD_MPLS_TOP_LABEL_IP_ADDR = NF9_DATA_FIELD(47),
    NF9_FIELD_FLOW_SAMPLER_ID = NF9_DATA_FIELD(48),
    NF9_FIELD_FLOW_SAMPLER_MODE = NF9_DATA_FIELD(49),
    NF9_FIELD_FLOW_SAMPLER_RANDOM_INTERVAL = NF9_DATA_FIELD(50),
    NF9_FIELD_F51 = NF9_DATA_FIELD(51),
    NF9_FIELD_F52 = NF9_DATA_FIELD(52),
    NF9_FIELD_F53 = NF9_DATA_FIELD(53),
    NF9_FIELD_F54 = NF9_DATA_FIELD(54),
    NF9_FIELD_DST_TOS = NF9_DATA_FIELD(55),
    NF9_FIELD_SRC_MAC = NF9_DATA_FIELD(56),
    NF9_FIELD_DST_MAC = NF9_DATA_FIELD(57),
    NF9_FIELD_SRC_VLAN = NF9_DATA_FIELD(58),
    NF9_FIELD_DST_VLAN = NF9_DATA_FIELD(59),
    NF9_FIELD_IP_PROTOCOL_VERSION = NF9_DATA_FIELD(60),
    NF9_FIELD_DIRECTION = NF9_DATA_FIELD(61),
    NF9_FIELD_IPV6_NEXT_HOP = NF9_DATA_FIELD(62),
    NF9_FIELD_BGP_IPV6_NEXT_HOP = NF9_DATA_FIELD(63),
    NF9_FIELD_IPV6_OPTION_HEADERS = NF9_DATA_FIELD(64),
    NF9_FIELD_F65 = NF9_DATA_FIELD(65),
    NF9_FIELD_F66 = NF9_DATA_FIELD(66),
    NF9_FIELD_F67 = NF9_DATA_FIELD(67),
    NF9_FIELD_F68 = NF9_DATA_FIELD(68),
    NF9_FIELD_F69 = NF9_DATA_FIELD(69),
    NF9_FIELD_MPLS_LABEL_1 = NF9_DATA_FIELD(70),
    NF9_FIELD_MPLS_LABEL_2 = NF9_DATA_FIELD(71),
    NF9_FIELD_MPLS_LABEL_3 = NF9_DATA_FIELD(72),
    NF9_FIELD_MPLS_LABEL_4 = NF9_DATA_FIELD(73),
    NF9_FIELD_MPLS_LABEL_5 = NF9_DATA_FIELD(74),
    NF9_FIELD_MPLS_LABEL_6 = NF9_DATA_FIELD(75),
    NF9_FIELD_MPLS_LABEL_7 = NF9_DATA_FIELD(76),
    NF9_FIELD_MPLS_LABEL_8 = NF9_DATA_FIELD(77),
    NF9_FIELD_MPLS_LABEL_9 = NF9_DATA_FIELD(78),
    NF9_FIELD_MPLS_LABEL_10 = NF9_DATA_FIELD(79),
    NF9_FIELD_IN_DST_MAC = NF9_DATA_FIELD(80),
    NF9_FIELD_OUT_SRC_MAC = NF9_DATA_FIELD(81),
    NF9_FIELD_IF_NAME = NF9_DATA_FIELD(82),
    NF9_FIELD_IF_DESC = NF9_DATA_FIELD(83),
    NF9_FIELD_SAMPLER_NAME = NF9_DATA_FIELD(84),
    NF9_FIELD_IN_PERMANENT_BYTES = NF9_DATA_FIELD(85),
    NF9_FIELD_IN_PERMANENT_PKTS = NF9_DATA_FIELD(86),
    NF9_FIELD_F87 = NF9_DATA_FIELD(87),
    NF9_FIELD_FRAGMENT_OFFSET = NF9_DATA_FIELD(88),
    NF9_FIELD_FORWARDING_STATUS = NF9_DATA_FIELD(89),
    NF9_FIELD_MPLS_PAL_RD = NF9_DATA_FIELD(90),
    NF9_FIELD_MPLS_PREFIX_LEN = NF9_DATA_FIELD(91),
    NF9_FIELD_SRC_TRAFFIC_INDEX = NF9_DATA_FIELD(92),
    NF9_FIELD_DST_TRAFFIC_INDEX = NF9_DATA_FIELD(93),
    NF9_FIELD_APPLICATION_DESCRIPTION = NF9_DATA_FIELD(94),
    NF9_FIELD_APPLICATION_TAG = NF9_DATA_FIELD(95),
    NF9_FIELD_APPLICATION_NAME = NF9_DATA_FIELD(96),
    NF9_FIELD_F97 = NF9_DATA_FIELD(97),
    NF9_FIELD_postipDiffServCodePoint = NF9_DATA_FIELD(98),
    NF9_FIELD_replication_factor = NF9_DATA_FIELD(99),
    NF9_FIELD_DEPRECATED = NF9_DATA_FIELD(100),
    NF9_FIELD_F101 = NF9_DATA_FIELD(101),
    NF9_FIELD_layer2packetSectionOffset = NF9_DATA_FIELD(102),
    NF9_FIELD_layer2packetSectionSize = NF9_DATA_FIELD(103),
    NF9_FIELD_layer2packetSectionData = NF9_DATA_FIELD(104),
    NF9_FIELD_F105 = NF9_DATA_FIELD(105),
    NF9_FIELD_F106 = NF9_DATA_FIELD(106),
    NF9_FIELD_F107 = NF9_DATA_FIELD(107),
    NF9_FIELD_F108 = NF9_DATA_FIELD(108),
    NF9_FIELD_F109 = NF9_DATA_FIELD(109),
    NF9_FIELD_F110 = NF9_DATA_FIELD(110),
    NF9_FIELD_F111 = NF9_DATA_FIELD(111),
    NF9_FIELD_F112 = NF9_DATA_FIELD(112),
    NF9_FIELD_F113 = NF9_DATA_FIELD(113),
    NF9_FIELD_F114 = NF9_DATA_FIELD(114),
    NF9_FIELD_F115 = NF9_DATA_FIELD(115),
    NF9_FIELD_F116 = NF9_DATA_FIELD(116),
    NF9_FIELD_F117 = NF9_DATA_FIELD(117),
    NF9_FIELD_F118 = NF9_DATA_FIELD(118),
    NF9_FIELD_F119 = NF9_DATA_FIELD(119),
    NF9_FIELD_F120 = NF9_DATA_FIELD(120),
    NF9_FIELD_F121 = NF9_DATA_FIELD(121),
    NF9_FIELD_F122 = NF9_DATA_FIELD(122),
    NF9_FIELD_F123 = NF9_DATA_FIELD(123),
    NF9_FIELD_F124 = NF9_DATA_FIELD(124),
    NF9_FIELD_F125 = NF9_DATA_FIELD(125),
    NF9_FIELD_F126 = NF9_DATA_FIELD(126),
    NF9_FIELD_F127 = NF9_DATA_FIELD(127),
    NF9_FIELD_F128 = NF9_DATA_FIELD(128),
    NF9_FIELD_F129 = NF9_DATA_FIELD(129),
    NF9_FIELD_F130 = NF9_DATA_FIELD(130),
    NF9_FIELD_F131 = NF9_DATA_FIELD(131),
    NF9_FIELD_F132 = NF9_DATA_FIELD(132),
    NF9_FIELD_F133 = NF9_DATA_FIELD(133),
    NF9_FIELD_F134 = NF9_DATA_FIELD(134),
    NF9_FIELD_F135 = NF9_DATA_FIELD(135),
    NF9_FIELD_F136 = NF9_DATA_FIELD(136),
    NF9_FIELD_F137 = NF9_DATA_FIELD(137),
    NF9_FIELD_F138 = NF9_DATA_FIELD(138),
    NF9_FIELD_F139 = NF9_DATA_FIELD(139),
    NF9_FIELD_F140 = NF9_DATA_FIELD(140),
    NF9_FIELD_F141 = NF9_DATA_FIELD(141),
    NF9_FIELD_F142 = NF9_DATA_FIELD(142),
    NF9_FIELD_F143 = NF9_DATA_FIELD(143),
    NF9_FIELD_F144 = NF9_DATA_FIELD(144),
    NF9_FIELD_F145 = NF9_DATA_FIELD(145),
    NF9_FIELD_F146 = NF9_DATA_FIELD(146),
    NF9_FIELD_F147 = NF9_DATA_FIELD(147),
    NF9_FIELD_F148 = NF9_DATA_FIELD(148),
    NF9_FIELD_F149 = NF9_DATA_FIELD(149),
    NF9_FIELD_F150 = NF9_DATA_FIELD(150),
    NF9_FIELD_F151 = NF9_DATA_FIELD(151),
    NF9_FIELD_F152 = NF9_DATA_FIELD(152),
    NF9_FIELD_F153 = NF9_DATA_FIELD(153),
    NF9_FIELD_F154 = NF9_DATA_FIELD(154),
    NF9_FIELD_F155 = NF9_DATA_FIELD(155),
    NF9_FIELD_F156 = NF9_DATA_FIELD(156),
    NF9_FIELD_F157 = NF9_DATA_FIELD(157),
    NF9_FIELD_F158 = NF9_DATA_FIELD(158),
    NF9_FIELD_F159 = NF9_DATA_FIELD(159),
    NF9_FIELD_F160 = NF9_DATA_FIELD(160),
    NF9_FIELD_F161 = NF9_DATA_FIELD(161),
    NF9_FIELD_F162 = NF9_DATA_FIELD(162),
    NF9_FIELD_F163 = NF9_DATA_FIELD(163),
    NF9_FIELD_F164 = NF9_DATA_FIELD(164),
    NF9_FIELD_F165 = NF9_DATA_FIELD(165),
    NF9_FIELD_F166 = NF9_DATA_FIELD(166),
    NF9_FIELD_F167 = NF9_DATA_FIELD(167),
    NF9_FIELD_F168 = NF9_DATA_FIELD(168),
    NF9_FIELD_F169 = NF9_DATA_FIELD(169),
    NF9_FIELD_F170 = NF9_DATA_FIELD(170),
    NF9_FIELD_F171 = NF9_DATA_FIELD(171),
    NF9_FIELD_F172 = NF9_DATA_FIELD(172),
    NF9_FIELD_F173 = NF9_DATA_FIELD(173),
    NF9_FIELD_F174 = NF9_DATA_FIELD(174),
    NF9_FIELD_F175 = NF9_DATA_FIELD(175),
    NF9_FIELD_F176 = NF9_DATA_FIELD(176),
    NF9_FIELD_F177 = NF9_DATA_FIELD(177),
    NF9_FIELD_F178 = NF9_DATA_FIELD(178),
    NF9_FIELD_F179 = NF9_DATA_FIELD(179),
    NF9_FIELD_F180 = NF9_DATA_FIELD(180),
    NF9_FIELD_F181 = NF9_DATA_FIELD(181),
    NF9_FIELD_F182 = NF9_DATA_FIELD(182),
    NF9_FIELD_F183 = NF9_DATA_FIELD(183),
    NF9_FIELD_F184 = NF9_DATA_FIELD(184),
    NF9_FIELD_F185 = NF9_DATA_FIELD(185),
    NF9_FIELD_F186 = NF9_DATA_FIELD(186),
    NF9_FIELD_F187 = NF9_DATA_FIELD(187),
    NF9_FIELD_F188 = NF9_DATA_FIELD(188),
    NF9_FIELD_F189 = NF9_DATA_FIELD(189),
    NF9_FIELD_F190 = NF9_DATA_FIELD(190),
    NF9_FIELD_F191 = NF9_DATA_FIELD(191),
    NF9_FIELD_F192 = NF9_DATA_FIELD(192),
    NF9_FIELD_F193 = NF9_DATA_FIELD(193),
    NF9_FIELD_F194 = NF9_DATA_FIELD(194),
    NF9_FIELD_F195 = NF9_DATA_FIELD(195),
    NF9_FIELD_F196 = NF9_DATA_FIELD(196),
    NF9_FIELD_F197 = NF9_DATA_FIELD(197),
    NF9_FIELD_F198 = NF9_DATA_FIELD(198),
    NF9_FIELD_F199 = NF9_DATA_FIELD(199),
    NF9_FIELD_F200 = NF9_DATA_FIELD(200),
    NF9_FIELD_F201 = NF9_DATA_FIELD(201),
    NF9_FIELD_F202 = NF9_DATA_FIELD(202),
    NF9_FIELD_F203 = NF9_DATA_FIELD(203),
    NF9_FIELD_F204 = NF9_DATA_FIELD(204),
    NF9_FIELD_F205 = NF9_DATA_FIELD(205),
    NF9_FIELD_F206 = NF9_DATA_FIELD(206),
    NF9_FIELD_F207 = NF9_DATA_FIELD(207),
    NF9_FIELD_F208 = NF9_DATA_FIELD(208),
    NF9_FIELD_F209 = NF9_DATA_FIELD(209),
    NF9_FIELD_F210 = NF9_DATA_FIELD(210),
    NF9_FIELD_F211 = NF9_DATA_FIELD(211),
    NF9_FIELD_F212 = NF9_DATA_FIELD(212),
    NF9_FIELD_F213 = NF9_DATA_FIELD(213),
    NF9_FIELD_F214 = NF9_DATA_FIELD(214),
    NF9_FIELD_F215 = NF9_DATA_FIELD(215),
    NF9_FIELD_F216 = NF9_DATA_FIELD(216),
    NF9_FIELD_F217 = NF9_DATA_FIELD(217),
    NF9_FIELD_F218 = NF9_DATA_FIELD(218),
    NF9_FIELD_F219 = NF9_DATA_FIELD(219),
    NF9_FIELD_F220 = NF9_DATA_FIELD(220),
    NF9_FIELD_F221 = NF9_DATA_FIELD(221),
    NF9_FIELD_F222 = NF9_DATA_FIELD(222),
    NF9_FIELD_F223 = NF9_DATA_FIELD(223),
    NF9_FIELD_F224 = NF9_DATA_FIELD(224),
    NF9_FIELD_F225 = NF9_DATA_FIELD(225),
    NF9_FIELD_F226 = NF9_DATA_FIELD(226),
    NF9_FIELD_F227 = NF9_DATA_FIELD(227),
    NF9_FIELD_F228 = NF9_DATA_FIELD(228),
    NF9_FIELD_F229 = NF9_DATA_FIELD(229),
    NF9_FIELD_F230 = NF9_DATA_FIELD(230),
    NF9_FIELD_F231 = NF9_DATA_FIELD(231),
    NF9_FIELD_F232 = NF9_DATA_FIELD(232),
    NF9_FIELD_F233 = NF9_DATA_FIELD(233),
    NF9_FIELD_Ingress_VRFID = NF9_DATA_FIELD(234),
    NF9_FIELD_Egress_VRFID = NF9_DATA_FIELD(235),
};

enum nf9_scope_field {
    NF9_SCOPE_FIELD_NONE = NF9_SCOPE_FIELD(0),
    NF9_SCOPE_FIELD_SYSTEM = NF9_SCOPE_FIELD(1),
    NF9_SCOPE_FIELD_INTERFACE = NF9_SCOPE_FIELD(2),
    NF9_SCOPE_FIELD_LINE_CARD = NF9_SCOPE_FIELD(3),
    NF9_SCOPE_FIELD_NETFLOW_CACHE = NF9_SCOPE_FIELD(4),
    NF9_SCOPE_FIELD_TEMPLATE = NF9_SCOPE_FIELD(5),
};

typedef struct nf9_state nf9_state;
typedef struct nf9_parse_result nf9_parse_result;
typedef struct nf9_stats nf9_stats;

NF9_API nf9_state* nf9_init(int flags);
NF9_API void nf9_free(nf9_state* state);

NF9_API int nf9_parse(nf9_state* state, nf9_parse_result** result,
                      const uint8_t* buf, size_t len, const nf9_addr* addr);

NF9_API void nf9_free_parse_result(const nf9_parse_result* result);

NF9_API size_t nf9_get_num_flowsets(const nf9_parse_result* pr);

NF9_API uint32_t nf9_get_timestamp(const nf9_parse_result* pr);
NF9_API uint32_t nf9_get_uptime(const nf9_parse_result* pr);

NF9_API int nf9_get_flowset_type(const nf9_parse_result* pr, unsigned flowset);

NF9_API size_t nf9_get_num_flows(const nf9_parse_result* pr, unsigned flowset);
NF9_API int nf9_get_field(const nf9_parse_result* pr, unsigned flowset,
                          unsigned flownum, nf9_field field, void* dst,
                          size_t* length);
NF9_API int nf9_get_option(const nf9_parse_result* pr, nf9_field field,
                           void* dst, size_t* length);

NF9_API const nf9_stats* nf9_get_stats(const nf9_state* state);
NF9_API uint64_t nf9_get_stat(const nf9_stats* stats, int stat);
NF9_API void nf9_free_stats(const nf9_stats*);
NF9_API int nf9_ctl(nf9_state* state, int opt, long value);

#ifdef __cplusplus
}
#endif

#endif  // NETFLOW9_H
